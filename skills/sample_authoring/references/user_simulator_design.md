# 用户模拟器设计指南

## 设计原则

用户模拟器是多轮评测的核心组件，模拟真实用户与Agent交互。

**核心目标**：让用户模拟器像真实用户一样行为自然、需求明确、反应合理。

## Prompt标准结构

```markdown
## 角色定义
你是{公司/组织}的{身份}，{简要背景}。

## 背景信息
- 用户ID：{id}
- 姓名：{name}
- {其他关键属性}

## 你的需求
- {核心需求描述}
- {具体参数1}
- {具体参数2}

## 信息披露策略
{披露模式说明}

## 行为约束
- 每次只生成一行消息
- 不要编造未提供的信息
- 保持符合角色的沟通风格

## 结束条件
当Agent成功完成你的需求时，表示满意并输出 ###STOP###
当Agent明确拒绝或无法满足需求时，说明情况后输出 ###STOP###
```

## 六大必备模块

### 1. 角色定义 (必需)

定义用户身份，建立对话基调：

```markdown
## 角色定义
你是Fitness Center的广告投放负责人，负责公司的线上广告投放策略。
```

```markdown
## 角色定义
你是公司员工张小明，职级为高级工程师，在技术部门工作3年。
```

### 2. 背景信息 (必需)

提供用户相关的具体数据，**必须与environment_dependency一致**：

```markdown
## 背景信息
- 广告主ID：adv_015
- 公司名称：Fitness Center
- 行业：教育培训
- 当前月预算：35000元
- 投放经验：中级
- 活动数量：3个进行中
```

**关键要求**：
- 数据必须从数据池中提取
- ID、金额、日期等必须精确
- 避免模糊描述

### 3. 需求描述 (必需)

明确用户的具体目标和参数：

```markdown
## 你的需求
- 请假类型：年假
- 请假时间：下周一到周三（3月25-27日，共3天）
- 请假原因：个人事务
- 期望结果：申请被批准，年假余额正确扣减
```

**设计要点**：
- 描述目标，不是对话流程
- 包含关键参数（时间、数量、类型）
- 说明约束条件和优先级

### 4. 信息披露策略 (必需)

定义用户如何逐步提供信息：

| 模式 | 特点 | 适用场景 |
|-----|------|---------|
| **upfront** | 一次性提供所有信息 | 紧急情况、简单任务 |
| **responsive** | 问一答一 | 常规流程、测试信息收集能力 |
| **progressive** | 先核心后细节 | 复杂需求、多约束场景 |

**示例 - Progressive模式**：
```markdown
## 信息披露策略
采用progressive模式：
1. 首轮只说"我想请几天假"
2. Agent询问类型时说"年假"
3. Agent询问时间时说"下周一到周三"
4. Agent询问原因时说"个人事务"
```

**示例 - Responsive模式**：
```markdown
## 信息披露策略
采用responsive模式：
- 只回答Agent主动询问的问题
- 不主动提供额外信息
- 如果Agent遗漏关键问题，可以在3轮后主动补充
```

### 5. 行为约束 (必需)

确保模拟器行为可控：

```markdown
## 行为约束
- 每次只生成一行消息来模拟用户话语
- 保持符合员工身份的沟通风格
- 不要编造数据池中没有的信息
- 不要主动提及工具名称或系统实现细节
- 不要在一轮对话中提供过多信息
```

### 6. 结束条件 (必需)

明确对话何时终止：

```markdown
## 结束条件
满意结束：当Agent成功处理你的请假申请并告知结果时，表示感谢并输出 ###STOP###
不满意结束：当Agent明确表示无法处理或拒绝时，表达失望并输出 ###STOP###
```

**重要**：`###STOP###`是标准结束标识，评测框架依赖此标识判断对话终止。

## 可选模块

### 个性化设定 (可选)

测试Agent处理不同用户类型的能力：

```markdown
## 个性化设定
- 用户类型：CONSERVATIVE（保守型）
- 决策态度：谨慎保守，不愿承担风险
- 沟通风格：会反复确认细节，决策较慢
- 特殊关注：非常在意预算安全
```

**典型用户类型**：

| 类型 | 特点 | 测试目标 |
|-----|------|---------|
| 保守型 | 犹豫、反复确认 | Agent的说服能力 |
| 激进型 | 快速决策、大胆尝试 | Agent的风险提示能力 |
| 专家型 | 懂行、问题专业 | Agent的专业深度 |
| 新手型 | 不懂术语、需要引导 | Agent的解释能力 |

## 动态生成模板

用户模拟器prompt通常由样本生成器动态生成：

```python
def build_user_simulator_prompt(employee, template):
    """根据员工数据和需求模板构建prompt"""

    prompt = f"""## 角色定义
你是公司员工{employee['name']}，职级{employee['position_level']}，在{employee['department']}工作。

## 背景信息
- 员工ID：{employee['employee_id']}
- 姓名：{employee['name']}
- 年假余额：{employee['annual_leave_balance']}天
- 调休余额：{employee['compensatory_leave_balance']}天

## 你的需求
- 请假类型：{template['leave_type']}
- 请假天数：{template['leave_days']}天
- 请假时间：{template['leave_dates']}
- 请假原因：{template['leave_reason']}

## 信息披露策略
{template['disclosure_strategy']}

## 行为约束
- 每次只生成一行消息
- 保持符合员工身份的沟通风格
- 不要编造未提供的信息

## 结束条件
当Agent成功处理你的申请时，表示满意并输出 ###STOP###
当Agent明确拒绝或无法满足需求时，说明情况后输出 ###STOP###
"""
    return prompt
```

## 质量检查清单

**必需检查**：
- [ ] 包含所有六大必备模块
- [ ] 背景信息与environment_dependency数据一致
- [ ] 需求描述具体明确，包含关键参数
- [ ] 信息披露策略与场景特点匹配
- [ ] 包含 `###STOP###` 结束标识
- [ ] 没有暴露系统实现细节

**质量指标**：
- prompt长度 >= 300字符
- 必须包含"背景信息"、"需求"、"结束条件"关键词
- 不应包含"第1轮"、"第2轮"等对话流程步骤

## 常见问题

**Q: 用户模拟器会无限对话吗？**
A: 通过`###STOP###`机制和max_turns配置双重保障，确保对话会终止。

**Q: 信息披露太快或太慢怎么办？**
A: 调整披露策略。如果Agent总是问不到关键信息，改用upfront模式；如果测试信息收集能力，用responsive模式。

**Q: 用户模拟器编造数据怎么办？**
A: 在行为约束中明确"不要编造未提供的信息"，并确保背景信息足够完整。

## 反例警示

**错误示例** - 过度控制对话流程：
```markdown
## 对话流程（错误！）
第1轮：说"我想请假"
第2轮：如果Agent问类型，说"年假"
第3轮：如果Agent问时间，说"下周一到周三"
...
```

**正确做法** - 描述目标和策略，让对话自然展开：
```markdown
## 你的需求
请3天年假，下周一到周三，原因是个人事务。

## 信息披露策略
采用progressive模式，先说核心需求，Agent询问时再提供细节。
```
