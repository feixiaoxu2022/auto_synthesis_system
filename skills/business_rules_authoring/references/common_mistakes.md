# 业务规则常见错误速查

## 错误分类概览

| 类别 | 错误数量 | 严重程度 | 影响 |
|------|---------|---------|------|
| **内容冗余错误** | **6个** | **极高** | **文档膨胀，核心规则淹没** |
| 技术泄露错误 | 5个 | 高 | 破坏业务视角 |
| 描述质量错误 | 4个 | 中 | 降低可执行性 |
| 结构完整性错误 | 3个 | 高 | 导致规则遗漏 |
| 表达规范错误 | 3个 | 低 | 影响专业性 |

---

## 0. 内容冗余错误（新增，最严重）

### 错误0.1：写了工具使用文档

```markdown
❌ ## 第二部分：工具规范

### 2.1 基础文件操作

#### 2.1.1 list_directory

**功能**：列举目录内容，支持递归、过滤、排序

**参数**：
- `path` (string, required): 目录路径
- `recursive` (boolean, optional): 是否递归列举
...（200行工具文档）

✅ （删除！工具文档应该在tools/*.py或unified_scenario_design.yaml中）
```

**判断标准**：BusinessRules.md不应该包含任何工具的参数说明、返回格式、错误场景等技术文档。

### 错误0.2：写了实体模型定义

```markdown
❌ ## 第一部分：实体模型

### 1.1 Files（文件实体）

**核心属性**：
| 属性 | 类型 | 说明 | 示例 |
|------|------|------|------|
| path | string | 绝对路径 | `/home/user/workspace/project/main.py` |
| name | string | 文件名 | `main.py` |
...（100行字段定义）

✅ （删除！实体模型应该在format_specifications.json中）
```

**判断标准**：BusinessRules.md只需要提及实体名称（如"文件"、"会议室"），不需要列举所有字段。

### 错误0.3：写了执行流程伪代码

```markdown
❌ **执行流程**：
```
1. 解析路径，提取父目录和文件名
2. 检查父目录是否存在
3. 检查文件是否已存在
   - 已存在且overwrite=false → 返回错误
   - 已存在且overwrite=true → 继续
4. 检查磁盘空间（内容长度 > 10MB时）
5. 创建文件并写入内容
6. 设置权限
7. 更新final_state
```

✅ 规则1.1（文件创建）：
- 当用户需要创建文件，且父目录存在、磁盘空间充足时
- 动作：创建指定路径的文件并写入内容
- 完成后回复："文件{filename}已成功创建。"
```

**判断标准**：用业务规则描述"做什么"，不要用伪代码描述"怎么做"。

### 错误0.4：写了系统设计和最佳实践

```markdown
❌ ### 7.1 Agent设计建议

#### 7.1.1 操作前检查

**建议的检查顺序**：
```python
def before_operation(operation, params):
    # 1. 存在性检查
    if not exists(params.path):
        return error("Path not found")
    ...
```

#### 7.1.2 错误处理模式
```python
# 模式1: 重试
def robust_copy(source, dest, max_retries=3):
    ...
```

✅ （完全删除！这是系统设计，不是业务规则）
```

**判断标准**：不要写给开发者看的内容，只写给Agent看的业务规则。

### 错误0.5：写了示例场景

```markdown
❌ ## 第五部分：用户需求场景

### 5.1 简单场景（Easy）

#### 场景1：创建项目结构

**用户需求**：
"创建一个Python项目的基本目录结构"

**期望操作**：
```
1. create_directory(path="/home/user/workspace/my_project", parents=true)
2. create_directory(path="/home/user/workspace/my_project/src")
...
```

✅ （删除！示例场景应该在samples/*.json中，不在BusinessRules.md中）
```

**判断标准**：BusinessRules.md定义规则，不举例说明。

### 错误0.6：写了Checker设计说明

```markdown
❌ ## 第六部分：验证规范

### 6.1 验证优先级

**必须遵循的验证顺序**：

1. **final_state状态验证**（最高优先级）
   - 检查实体属性值
   - 检查实体存在性
...

### 6.2 检查点设计示例
```yaml
check_items:
  - check_type: entity_exists
    params:
      entity_type: files
...
```

✅ （删除！Checker设计应该在checkers/*.py中，不在BusinessRules.md中）
```

**判断标准**：BusinessRules.md是给Agent看的规则，不是给Checker看的验证说明。

---

## 0.7 内容冗余快速扫描

**危险信号关键词**（出现任何一个都要警惕）：
- 章节标题：`工具规范`、`实体模型`、`验证规范`、`示例场景`、`最佳实践`
- 内容特征：`**参数**：`、`**返回**：`、`**错误场景**：`、`check_type:`
- 代码块：Python代码、伪代码、YAML配置块

**长度判断原则**：
遵循"每条规则必须师出有名"，长度自然合理。警惕信号：
- 总行数 > 500行 → 很可能写了不该写的内容
- 某个"规则组"超过50行 → 检查是否混入了工具文档
- 某条"规则"超过20行 → 检查是否写成了流程说明

---

## 1. 技术泄露错误

### 错误1：暴露工具调用

```markdown
❌ 核心动作：调用create_appointment工具创建预订
❌ 参数：patient_id, doctor_id, appointment_time

✅ 规则1.1（医生预约安排）：
- 当用户意图为"预订医生"，且存在可用医生时
- 动作：为用户安排合适的预约时间和医生
- 完成后回复："您的预约已成功处理。预约时间：{appointment_time}，医生：{doctor_name}。"
```

### 错误2：使用数据库字段名

```markdown
❌ 当user.tier == 'vip'且order.amount > 10000时
❌ 更新order.status = 'priority_processing'

✅ 规则2.3（VIP订单优先处理）：
- 当用户为VIP客户，且订单金额超过10000元时
- 动作：将订单标记为优先处理，安排专属客服跟进
- 完成后回复："您的订单已进入优先处理通道，专属客服将在30分钟内联系您。"
```

### 错误3：描述Checker验证逻辑

```markdown
❌ 成功标准：
  1. final_state中存在新的booking记录
  2. booking.status == 'confirmed'
  3. room.status == 'occupied'

✅ 完成后回复："您的会议室预订已确认。会议室{room_name}已为您预留，时间为{date} {time_slot}。"
```

### 错误4：使用技术状态码

```markdown
❌ 当操作失败，返回status_code=400时
❌ 回复："操作失败，错误码：{error_code}"

✅ 当预订操作失败时，根据失败原因提供明确的说明：
  - 如果会议室不可用：回复"抱歉，该会议室在您选择的时段已被预订。"
  - 如果权限不足：回复"您暂无预订该会议室的权限。"
```

### 错误5：引用技术配置项

```markdown
❌ 从mock_db.json读取员工信息
❌ 检查employee.leave_balance字段
❌ 调用update_employee_record API更新余额

✅ 规则5.1（请假余额管理）：
- 当员工提交请假申请时
- 动作：检查员工的假期余额是否充足，如充足则批准申请并扣减相应天数
- 完成后回复："您的请假申请已批准。已使用{used_days}天，剩余：{remaining_balance}天。"
```

---

## 2. 描述质量错误

### 错误6：规则过于笼统

```markdown
❌ 当用户需要帮助时
❌ 动作：提供帮助
❌ 完成后回复："已为您处理。"

✅ 规则1.1（技术故障申报）：
- 当员工报告技术问题，问题严重程度为"高"或"紧急"时
- 动作：立即创建工单并分配给值班技术人员，同时通知技术主管
- 完成后回复："您的技术故障工单已创建（工单号：{ticket_id}），值班工程师{engineer_name}将在15分钟内联系您。"
```

### 错误7：触发条件不明确

```markdown
❌ 当用户很重要时
❌ 动作：优先处理

✅ 规则2.2（VIP客户优先服务）：
- 当用户为VIP客户（年消费额≥50万元），或用户为企业合作伙伴时
- 动作：将服务请求标记为最高优先级，安排资深客服在10分钟内响应
```

### 错误8：业务动作描述不具体

```markdown
❌ 动作：处理用户请求
❌ 完成后回复："处理完成。"

✅ 动作：
  1. 记录借用信息（借用人、设备、预计归还时间）
  2. 更新设备状态为"借出中"
  3. 发送借用确认和归还提醒
- 完成后回复："设备{device_name}已为您预留。请在{return_date}前归还。"
```

### 错误9：回复内容不专业

```markdown
❌ 完成后回复："搞定了！"
❌ 失败时回复："出错了，不行。"
❌ 完成后回复："OK，已处理。"

✅ 完成后回复："您的会议室预订已成功处理。会议室{room_name}已为您预留，时间为{date} {start_time}-{end_time}。"
✅ 失败时回复："抱歉，您选择的时段暂无可用会议室。建议您调整预订时间或联系行政部门协助安排。"
```

---

## 3. 结构完整性错误

### 错误10：缺少异常情况处理

```markdown
❌ 只有成功情况：
- 当用户申请差旅时
- 动作：处理差旅申请
- 完成后回复："差旅申请已提交。"

✅ 包含异常处理：
**异常情况处理**：
- 如果预算超出额度：回复"您的差旅预算超出可用额度。建议调整预算或联系财务部门申请额外批准。"
- 如果目的地在黑名单：回复"该目的地目前暂停差旅，请参考公司差旅政策。"
- 如果与其他差旅冲突：回复"检测到您在{conflicting_date}已有差旅安排。"
```

### 错误11：遗漏必要的系统角色定义

```markdown
❌ 直接开始写规则：
# 会议室预订 - 业务规则
## 业务规则
...

✅ 完整结构：
# 会议室预订 - 业务规则

## 系统角色定义
你是智能办公助手，负责协助员工预订会议室、管理会议资源。

## 核心能力
- 处理会议室预订请求
- 提供会议室使用建议
- 管理会议资源冲突

## 业务规则
...
```

### 错误12：缺少通用约束和原则

```markdown
❌ 只列出具体规则，没有整体性的约束

✅ 包含通用约束：
## 通用约束和原则

### 数据完整性原则
- 所有预订操作必须即时记录
- 会议室状态更新必须与预订操作同步

### 用户体验原则
- 使用礼貌、专业的语言
- 主动提供相关建议和替代方案
- 操作失败时明确说明原因和解决建议
```

---

## 4. 表达规范错误

### 错误13：规则编号不规范

```markdown
❌ 规则1：预订会议室
❌ 规则A：处理请假
❌ 预订规则：...

✅ 规则1.1（标准会议室预订）：
✅ 规则1.2（紧急会议室预订）：
✅ 规则2.1（标准请假申请）：
```

### 错误14：条件和动作混淆

```markdown
❌ 当用户预订会议室并检查可用性时
❌ 动作：如果可用则创建预订

✅ 规则2.1（会议室预订处理）：
- 当用户意图为"预订会议室"，且提供了时间和参会人数信息时
- 动作：
  1. 检查指定时段的会议室可用性
  2. 如果有可用会议室，选择最合适的并创建预订
  3. 如果无可用会议室，提供替代时段或会议室建议
```

### 错误15：占位符格式不统一

```markdown
❌ 回复："预订成功，会议室名称，日期date，时间time。"
❌ 回复："预订成功，会议室{room}，{Date}，【time】。"

✅ 回复："您的会议室预订已成功。会议室{room_name}已为您预留，时间为{date} {start_time}-{end_time}。"
```

**占位符规范**：
- 统一使用`{variable_name}`格式
- 变量名使用snake_case命名风格

---

## 技术泄露快速扫描

使用全文搜索检查是否包含：
- 工具名称关键词：`create_`, `update_`, `delete_`, `_tool`, `_api`
- 数据字段关键词：`.`, `_id`, `_status`, `_code`
- 技术术语关键词：`mock_db`, `final_state`, `check_`, `verify_`
