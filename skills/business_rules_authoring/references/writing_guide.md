# 业务规则编写详细指南

## 目录
- [阶段1：框架搭建](#阶段1框架搭建15分钟)
- [阶段2：规则详细设计](#阶段2规则详细设计45-90分钟)
- [阶段3：通用约束和原则](#阶段3通用约束和原则20分钟)
- [阶段4：异常情况处理](#阶段4异常情况处理30分钟)
- [阶段5：自检和优化](#阶段5自检和优化20分钟)

---

## 阶段1：框架搭建（15分钟）

### 步骤1.1：创建基础结构

```bash
cp skills/business_rules_authoring/templates/BusinessRules_template.md \
   scenarios/{scenario_name}/BusinessRules.md
```

### 步骤1.2：填写基本信息

1. 替换`{场景名称}`为实际场景名称
2. 定义`系统角色`：明确Agent扮演的角色和职责
3. 列出`核心能力`：3-5个核心能力点
4. 规划`规则组`：根据业务逻辑划分（建议3-5个规则组）

**检查点**：
- [ ] 场景名称已正确填写
- [ ] 系统角色定义清晰具体
- [ ] 核心能力列表完整
- [ ] 规则组分类合理

---

## 阶段2：规则详细设计（45-90分钟）

### 步骤2.1：编写核心规则

**1. 确定规则编号和名称**
- 格式：`规则X.Y（简短名称）`
- X=规则组编号，Y=组内序号

**2. 设计触发条件**

| 要求 | 说明 |
|-----|------|
| 使用业务术语 | 避免技术字段名 |
| 可明确判断 | 条件真假可判定 |
| 逻辑清晰 | 明确"且"/"或"关系 |
| 数量合理 | 建议2-5个条件 |

**好的示例**：
```markdown
✅ 当用户为VIP客户，且订单金额>10000元时
✅ 当任务优先级为"紧急"，且无其他紧急任务时
```

**不好的示例**：
```markdown
❌ 当用户很重要时（模糊）
❌ 当user.tier == 'vip'时（技术化）
```

**3. 描述业务动作**

| 原则 | 说明 |
|-----|------|
| 描述"做什么" | 而非"怎么做" |
| 使用业务语言 | 不是技术实现 |
| 具体可执行 | 能明确判断是否完成 |

**4. 编写标准回复**

| 要求 | 示例 |
|-----|------|
| 明确操作结果 | "您的预订已成功处理" |
| 包含关键信息 | 使用占位符{room_name}、{date} |
| 专业礼貌语气 | "如需调整请提前2小时通知" |

### 步骤2.2：规则优先级设计

| 优先级类型 | 说明 |
|-----------|------|
| 互斥规则 | 明确不同条件下触发不同规则 |
| 覆盖规则 | 特殊规则覆盖通用规则 |
| 组合规则 | 多个规则可同时生效的情况 |

**优先级标记方式**：
```markdown
**规则1.1（VIP用户服务）：** <!-- 优先级：最高 -->
**规则1.2（普通用户服务）：** <!-- 优先级：标准 -->
```

### 步骤2.3：边界情况处理

| 边界类型 | 示例 |
|---------|------|
| 资源不足 | 会议室已满、库存不足 |
| 数据异常 | 输入数据不合规 |
| 业务限制 | 预算超限、频次超限 |
| 权限问题 | 用户权限不足 |

**检查点**：
- [ ] 每个规则组至少包含2条规则
- [ ] 所有规则都有完整的"触发条件-动作-回复"
- [ ] 规则之间的优先级关系清晰
- [ ] 关键边界情况有明确处理说明

---

## 阶段3：通用约束和原则（20分钟）

### 步骤3.1：定义通用约束

**1. 数据完整性原则**
```markdown
- 所有预订操作必须即时记录，确保数据一致性
- 会议室状态更新必须与预订操作同步
- 取消预订时必须恢复会议室可用状态
```

**2. 用户体验原则**
```markdown
- 所有回复必须在30秒内完成
- 使用礼貌、专业的语言与用户沟通
- 主动提供相关建议和替代方案
- 操作失败时明确说明原因和解决建议
```

**3. 合规和安全原则**
```markdown
- 验证用户权限后再执行敏感操作
- 保护用户隐私信息
- 遵循公司政策和管理规定
```

### 步骤3.2：设计信息收集策略（多轮对话场景）

**关键信息列表示例**：
```markdown
1. **预订时间**（必需）
   - 示例问法："请问您希望预订什么时间的会议室？"
   - 追问策略：如果用户只说"明天"，需进一步确认具体时段

2. **参会人数**（必需）
   - 示例问法："请问预计有多少人参会？"

3. **设备需求**（可选）
   - 示例问法："请问需要投影仪或视频会议设备吗？"
```

**对话流程设计**：
```markdown
1. 需求理解阶段（1-2轮）- 识别核心意图，收集必需信息
2. 方案制定阶段（1轮）- 提出解决方案
3. 方案确认阶段（1轮）- 确认是否满足需求
4. 执行反馈阶段（1轮）- 执行并提供结果反馈
```

---

## 阶段4：异常情况处理（30分钟）

### 步骤4.1：识别异常场景

**常见异常类型**：
| 类型 | 示例 |
|-----|------|
| 资源不可用 | 会议室已满、库存不足 |
| 用户信息不完整 | 缺少必要参数 |
| 超出业务限制 | 预算超限、频次超限 |
| 需要额外审批 | 超出权限范围 |
| 系统或数据异常 | 数据错误、服务不可用 |

### 步骤4.2：设计异常处理流程

**异常处理模板**：
```markdown
### 异常场景：{异常类型}
- **判断条件**：{明确的判断标准}
- **处理方式**：{步骤1 → 步骤2 → 步骤3}
- **回复内容**："{清晰的异常说明和建议}"
```

**示例**：
```markdown
### 会议室资源冲突
- **判断条件**：用户选择的时段会议室已被预订
- **处理方式**：提示冲突 → 查询替代方案 → 提供建议
- **回复内容**："抱歉，{room_name}在{time_slot}已被预订。建议您考虑：1) {alternative_room}在同时段可用；2) {room_name}在{alternative_time}可用。"
```

**检查点**：
- [ ] 至少定义4个常见异常场景
- [ ] 每个异常都有明确的处理流程
- [ ] 异常回复内容清晰、有建设性

---

## 阶段5：自检和优化（20分钟）

### 步骤5.1：运行质量检查清单

参考 [quality_checklist.md](quality_checklist.md)

### 步骤5.2：业务视角审查

逐行审查文档，确保：
- [ ] 没有出现技术术语（工具名、字段名、表名）
- [ ] 没有暴露评测框架细节
- [ ] 所有描述都从业务视角出发
- [ ] 语言专业、清晰、准确

### 步骤5.3：可验证性审查

确认每条规则都可以被验证：
- [ ] 触发条件可以明确判断真假
- [ ] 业务动作具体且可执行
- [ ] 标准回复内容明确
- [ ] 异常情况有明确判断标准

### 步骤5.4：对比优秀案例

```bash
ls skills/business_rules_authoring/examples/
```

---

## 常见问题

### 问题1：规则粒度难以把握

**解决方案**：
- 遵循"一个规则解决一类问题"原则
- 触发条件建议2-5个
- 动作描述超过5行，考虑拆分

### 问题2：难以避免技术术语

**解决方案**：
- ❌ "调用create_booking工具" → ✅ "为用户创建预订"
- ❌ "更新room表的status字段" → ✅ "标记会议室为已占用状态"

### 问题3：异常情况遗漏

**系统性穷举方法**：
1. 输入异常（用户输入不合规、信息缺失）
2. 资源异常（不可用、不足、冲突）
3. 权限异常（用户权限不足、需要审批）
4. 业务约束异常（超限、违反规则）
5. 系统异常（数据错误、服务不可用）
