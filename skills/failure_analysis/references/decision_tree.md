# 归因决策树

## 目录
- [主决策树](#主决策树)
- [final_state分析决策树](#final_state分析决策树)
- [Checker准确性决策树](#checker准确性决策树)
- [用户模拟器行为决策树](#用户模拟器行为决策树)
- [快速判断表](#快速判断表)

---

## 主决策树

```
失败案例
    │
    ├─ Checker判断是否正确？
    │   └─ 否 → Checker验证结果与实际情况不符
    │           └─ 进入【Checker准确性决策树】
    │
    └─ 是，Checker判断正确
        │
        ├─ final_state是否符合expected_state？
        │   └─ 否 → 进入【final_state分析决策树】
        │
        └─ 是，状态符合预期
            │
            ├─ Agent是否完成了必要的业务操作？
            │   ├─ 否 → Agent遗漏了关键操作
            │   │       │
            │   │       └─ BusinessRules是否明确要求？
            │   │           ├─ 是 → 【Agent能力问题】
            │   │           └─ 否 → 【样本设计问题】（规则不明确）
            │   │
            │   └─ 是 → 检查用户模拟器行为
            │           └─ 进入【用户模拟器行为决策树】
            │
            └─ 其他情况 → 深入分析对话历史
```

---

## final_state分析决策树

**触发条件**：final_state与expected_state不符

```
final_state异常
    │
    ├─【验证层1】查看相关工具实现代码
    │   │
    │   └─ 工具是否应该负责该状态更新？
    │       ├─ 是，工具应负责
    │       │   └─ 工具实现是否正确？
    │       │       ├─ 否 → 【系统问题】（工具实现bug）
    │       │       └─ 是 → Agent是否正确调用了工具？
    │       │               ├─ 否 → 【Agent能力问题】（未调用/参数错误）
    │       │               └─ 是 → 【系统问题】（工具执行异常）
    │       │
    │       └─ 否，工具不负责 → 进入验证层2
    │
    ├─【验证层2】检查Agent操作完整性
    │   │
    │   └─ Agent是否调用了应该负责的工具？
    │       ├─ 是，调用了
    │       │   └─ 调用参数是否正确？
    │       │       ├─ 否 → 【Agent能力问题】（参数错误）
    │       │       └─ 是 → 【系统问题】（工具问题）
    │       │
    │       └─ 否，未调用 → 进入验证层3
    │
    └─【验证层3】检查业务规则明确性
        │
        └─ BusinessRules是否明确要求该操作？
            ├─ 是 → 【Agent能力问题】（遗漏操作）
            └─ 否 → 【样本设计问题】（规则不明确）
```

### 实例说明

```
案例：LA场景create_leave_application后余额未扣减

验证层1：查看create_leave_application工具代码
  → 工具注释说明："本工具不负责更新员工余额"
  → 结论：工具不负责，进入验证层2

验证层2：检查Agent是否调用了update_employee_leave_balance
  → 对话历史显示：Agent未调用该工具
  → 结论：Agent遗漏了调用，进入验证层3

验证层3：检查BusinessRules
  → 规则未明确要求Agent必须调用update_employee_leave_balance
  → 最终归因：【样本设计问题】（规则不明确）
```

---

## Checker准确性决策树

**触发条件**：怀疑Checker判断可能有误

```
Checker判断结果
    │
    ├─ Checker条件与BusinessRules是否一致？
    │   ├─ 否 → 【样本设计问题】（Checker条件设计不合理）
    │   └─ 是 → 继续检查
    │
    ├─ Checker读取的数据是否正确？
    │   ├─ 否 → 【系统问题】（Checker读取数据错误）
    │   └─ 是 → 继续检查
    │
    ├─ Checker比较逻辑是否正确？
    │   ├─ 否 → 【系统问题】（Checker逻辑bug）
    │   └─ 是 → 继续检查
    │
    └─ Checker临界值是否合理？
        ├─ 否 → 【样本设计问题】（临界值设定不合理）
        └─ 是 → Checker判断正确，问题在其他环节
```

---

## 用户模拟器行为决策树

**触发条件**：需要判断用户模拟器行为是否正常

```
用户模拟器行为
    │
    ├─ 用户行为是否符合user_simulator_prompt？
    │   │
    │   ├─ 是，符合prompt
    │   │   └─ prompt设计是否合理？
    │   │       ├─ 否 → 【样本设计问题】（prompt设计不当）
    │   │       └─ 是 → 用户模拟器表现正常，问题在其他环节
    │   │
    │   └─ 否，不符合prompt
    │       │
    │       └─ 偏离的类型？
    │           ├─ 角色定位偏离 → 【用户模拟器执行问题】
    │           ├─ 信息透露时机不对 → 【用户模拟器执行问题】
    │           ├─ 配合程度不符 → 【用户模拟器执行问题】
    │           └─ STOP时机异常 → 【用户模拟器执行问题】
    │
    └─ 特殊情况判断
        │
        ├─ Agent给了用户表达机会吗？
        │   ├─ 否 → 【Agent能力问题】（未给用户机会）
        │   └─ 是 → 用户是否利用了机会？
        │           ├─ 否 → 检查prompt是否要求表达
        │           │       ├─ 是 → 【用户模拟器执行问题】
        │           │       └─ 否 → 【样本设计问题】
        │           └─ 是 → Agent是否响应了？
        │                   ├─ 否 → 【Agent能力问题】
        │                   └─ 是 → 正常流程
```

---

## 快速判断表

### Agent能力问题判断表

| 现象 | 条件 | 判断 |
|-----|------|------|
| Agent未询问用户 | BusinessRules明确要求询问 | Agent能力问题 |
| Agent未响应用户需求 | 用户明确表达了需求 | Agent能力问题 |
| Agent工具调用参数错误 | 参数与用户需求不符 | Agent能力问题 |
| Agent执行顺序错误 | 违反BusinessRules流程 | Agent能力问题 |
| Agent遗漏关键操作 | BusinessRules明确要求 | Agent能力问题 |

### 样本设计问题判断表

| 现象 | 条件 | 判断 |
|-----|------|------|
| Checker过严/过宽 | 与BusinessRules不一致 | 样本设计问题 |
| Agent遗漏操作 | BusinessRules未明确要求 | 样本设计问题 |
| user_simulator_prompt矛盾 | 角色行为自相矛盾 | 样本设计问题 |
| checklist验证不合理 | 验证内容不符合业务需求 | 样本设计问题 |
| expected_state不合理 | 期望状态与业务逻辑不符 | 样本设计问题 |

### 用户模拟器执行问题判断表

| 现象 | 条件 | 判断 |
|-----|------|------|
| 用户角色偏离 | 与prompt设定不符 | 用户模拟器执行问题 |
| 信息透露时机异常 | 与prompt策略不符 | 用户模拟器执行问题 |
| 配合程度异常 | 与prompt设定不符 | 用户模拟器执行问题 |
| STOP时机不合理 | 过早/过晚结束对话 | 用户模拟器执行问题 |
| 产生超出设计的内容 | prompt中未设定的行为 | 用户模拟器执行问题 |

### 系统问题判断表

| 现象 | 条件 | 判断 |
|-----|------|------|
| 工具未更新状态 | 工具应负责但未执行 | 系统问题 |
| 工具返回数据错误 | 返回格式/内容错误 | 系统问题 |
| Checker逻辑错误 | 实现与设计不符 | 系统问题 |
| 框架执行异常 | 框架代码bug | 系统问题 |
