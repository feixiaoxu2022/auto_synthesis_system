# 8步分析流程详解

## 目录
- [前置准备](#前置准备)
- [步骤1：基础信息收集](#步骤1基础信息收集)
- [步骤2：逐轮对话分析](#步骤2逐轮对话分析)
- [步骤3：期望vs实际对比](#步骤3期望vs实际对比)
- [步骤4：失败根因推导](#步骤4失败根因推导)
- [步骤5：final_state验证](#步骤5final_state验证)
- [步骤6：用户模拟器行为验证](#步骤6用户模拟器行为验证)
- [步骤7：关键证据验证](#步骤7关键证据验证)
- [步骤8：归因结论确定](#步骤8归因结论确定)

---

## 前置准备

### 必须阅读的文件

1. **评测结果JSON** - 包含conversation_history、final_state、checklist等
2. **BusinessRules.md** - 理解业务规则要求
3. **user_simulator_prompt** - 理解用户模拟器的预设行为

### 关键字段说明

| 字段 | 内容 | 作用 |
|-----|------|------|
| conversation_history | 完整对话记录 | 分析Agent行为的主要依据 |
| final_state | 执行后的系统状态 | 验证Agent操作效果 |
| expected_state | 期望的系统状态 | 判断是否符合预期 |
| checklist | 验证点列表 | 识别具体失败点 |
| user_simulator_prompt | 用户模拟器设定 | 判断用户行为是否合理 |

---

## 步骤1：基础信息收集

### 操作清单

1. **提取评测指标**
   - 总体通过率
   - 各checklist项的通过情况
   - 失败的具体验证点

2. **识别失败点**
   - 哪些checklist项失败
   - 失败原因描述
   - 关联的业务规则

3. **记录关键元数据**
   - 场景名称
   - 样本ID
   - Agent模型版本

### 输出格式

```markdown
## 基础信息
- 场景：{scenario_name}
- 样本ID：{sample_id}
- 总体结果：{pass/fail}
- 失败点：
  1. {checklist_item_1}: {reason}
  2. {checklist_item_2}: {reason}
```

---

## 步骤2：逐轮对话分析

### 操作清单

1. **从第一轮开始逐轮阅读**
   - 记录每轮user说了什么
   - 记录每轮assistant做了什么（包括工具调用）
   - 标记关键转折点

2. **识别关键信息**
   - 用户表达的需求
   - Agent的理解和响应
   - 工具调用和返回结果

3. **标记异常点**
   - Agent未响应用户需求的地方
   - Agent理解错误的地方
   - 工具调用异常的地方

### 常见错误提醒

- ❌ 只看最后几轮对话就下结论
- ❌ 基于summary而非原始对话分析
- ✅ 必须从第一轮开始完整阅读

---

## 步骤3：期望vs实际对比

### 操作清单

1. **提取user_simulator_prompt设定**
   - 用户角色定位
   - 期望表达的需求
   - 信息透露策略
   - 配合程度设定

2. **对比实际表达**
   - 用户实际说了什么
   - 在哪一轮说的
   - 与预设是否一致

3. **识别差异**
   - 预设要表达但实际未表达的
   - 实际表达但预设没有的
   - 表达时机的差异

### 关键区分

| 情况 | 归因方向 |
|-----|---------|
| prompt设定要表达，用户也表达了，Agent未响应 | Agent能力问题 |
| prompt设定要表达，但用户实际未表达 | 用户模拟器执行问题 |
| prompt设定不合理导致用户行为异常 | 样本设计问题 |

---

## 步骤4：失败根因推导

### 操作清单

1. **列出可能的失败原因**
   - 基于前面步骤的发现
   - 考虑多种可能性

2. **逐一排查**
   - 每个可能原因是否有证据支持
   - 排除没有证据的假设

3. **确定最可能的根因**
   - 证据最充分的原因
   - 能解释所有观察到的现象

### 推理原则

- **不停留在表面** - 如"Agent没有询问"，要追问"为什么没有询问"
- **区分主观vs被动** - Agent是主观选择错误还是没有机会做对
- **考虑系统因素** - 是否工具/数据问题导致Agent行为异常

---

## 步骤5：final_state验证

### 操作清单

1. **对比final_state和expected_state**
   - 哪些字段不一致
   - 不一致的程度

2. **追溯Agent操作**
   - Agent调用了哪些工具
   - 工具调用的参数是什么
   - 工具返回了什么

3. **验证一致性**
   - Agent的操作意图是否正确
   - 操作结果是否符合意图
   - 结果是否反映在final_state中

### 三层验证机制

当final_state异常时，必须运用三层验证：
1. **工具职责边界** - 工具是否应该负责该状态
2. **Agent操作完整性** - Agent是否遗漏了必要操作
3. **业务规则明确性** - 规则是否明确要求该操作

详见 [decision_tree.md](decision_tree.md)

---

## 步骤6：用户模拟器行为验证

### 操作清单

1. **逐项验证prompt遵循情况**
   - 角色定位一致性
   - 信息透露策略
   - 配合程度
   - STOP时机

2. **标记偏离点**
   - 哪些行为偏离了prompt
   - 偏离的程度
   - 对结果的影响

3. **判断问题类型**
   - prompt本身设计问题 → 样本设计问题
   - 执行时偏离prompt → 用户模拟器执行问题

### 验证维度

| 维度 | 检查内容 |
|-----|---------|
| 角色定位 | 实际角色是否符合prompt设定 |
| 信息透露 | 信息透露时机是否符合prompt |
| 配合程度 | 是否按设定的配合度行为 |
| STOP时机 | 结束对话的时机是否合理 |

---

## 步骤7：关键证据验证

### 操作清单

1. **整理证据链**
   - 每个结论对应的证据
   - 证据的来源（对话轮次、JSON字段等）

2. **验证证据完整性**
   - 是否有遗漏的关键证据
   - 证据是否能支撑结论

3. **交叉验证**
   - 不同来源的证据是否一致
   - 是否存在矛盾

### 证据格式

```markdown
## 证据1
- 来源：第{N}轮对话
- 内容："{具体引用}"
- 支撑结论：{xxx}

## 证据2
- 来源：final_state.{field}
- 内容：{value}
- 支撑结论：{xxx}
```

---

## 步骤8：归因结论确定

### 操作清单

1. **确定归因分类**
   - Agent能力问题
   - 样本设计问题
   - 用户模拟器执行问题
   - 系统问题

2. **说明归因理由**
   - 为什么选择这个分类
   - 排除其他分类的理由

3. **提供改进建议**
   - 针对归因类型的具体建议
   - 可操作的改进方向

### 输出格式

```markdown
## 归因结论

### 归因分类
{Agent能力问题 / 样本设计问题 / 用户模拟器执行问题 / 系统问题}

### 归因理由
1. {理由1，附带证据引用}
2. {理由2，附带证据引用}

### 改进建议
1. {建议1}
2. {建议2}
```
